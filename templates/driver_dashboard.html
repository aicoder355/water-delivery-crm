{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-center">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2 sm:mb-0">Личный кабинет водителя</h2>
        <a href="{% url 'reports' %}" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 mr-2">Отчёты</a>
        <a href="{% url 'logout' %}" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Выйти</a>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-base sm:text-lg font-medium mb-4">Ваши заказы</h3>
        <form class="mb-4 flex flex-wrap gap-2 items-end">
            <select name="status" class="border rounded px-2 py-1" title="Статус">
                <option value="">Все статусы</option>
                <option value="planned" {% if status_filter == 'planned' %}selected{% endif %}>Запланирован</option>
                <option value="delivered" {% if status_filter == 'delivered' %}selected{% endif %}>Доставлен</option>
                <option value="canceled" {% if status_filter == 'canceled' %}selected{% endif %}>Отменён</option>
            </select>
            <select name="region" class="border rounded px-2 py-1" title="Регион">
                <option value="">Все регионы</option>
                {% for region in regions %}
                <option value="{{ region.id }}" {% if region_id == region.id|stringformat:'s' %}selected{% endif %}>{{ region.name }}</option>
                {% endfor %}
            </select>
            <select name="client" class="border rounded px-2 py-1" title="Клиент">
                <option value="">Все клиенты</option>
                {% for client in clients %}
                <option value="{{ client.id }}" {% if client_id == client.id|stringformat:'s' %}selected{% endif %}>{{ client.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Показать</button>
        </form>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Клиент</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Продукт</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Количество</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Статус</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Дата заказа</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Адрес доставки</th>
                        <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Действия</th>
                    </tr>
                </thead>
                <tbody id="order-table-body" class="divide-y divide-gray-200">
                    {% for order in orders %}
                    <tr>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.id }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.client.name }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.product.name }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.quantity }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.get_status_display }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.order_date|date:"d.m.Y H:i" }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm">{{ order.delivery_address }}</td>
                        <td class="px-2 sm:px-4 py-2 text-sm space-x-1">
                            <input type="number" min="1" max="{{ order.quantity }}" value="{{ order.quantity }}" id="return-qty-{{ order.id }}" class="w-16 border rounded px-1 py-0.5 text-xs align-middle" style="width:60px;" placeholder="Тара">
                            <button type="button" class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 text-xs" data-order-id="{{ order.id }}">Выполнен</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-2 sm:px-4 py-2 text-center text-gray-500">Нет заказов</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('button[data-order-id]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const qty = document.getElementById('return-qty-' + orderId).value;
            fetch(`/api/orders/` + orderId + `/update/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ status: 'delivered', paid: true, return_quantity: qty }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при выполнении заказа.');
                }
            });
        });
    });
});
</script>
<script>
// WebSocket для push-уведомлений водителю
(function() {
    let protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    let wsPath = protocol + '://' + window.location.host + '/ws/driver/';
    let socket = new WebSocket(wsPath);
    socket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        if (data.message) {
            // Можно заменить на красивое всплывающее уведомление
            alert(data.message);
        }
    };
    socket.onclose = function() {
        // Попробовать переподключиться через 5 секунд
        setTimeout(function() { window.location.reload(); }, 5000);
    };
})();
</script>
{% endblock %}